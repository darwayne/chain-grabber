package memspender

import (
	"github.com/darwayne/chain-grabber/internal/test/testhelpers"
	"github.com/stretchr/testify/require"
	"testing"
)

func TestNewParsedScript(t *testing.T) {
	t.Run("should detect multisig segwit", func(t *testing.T) {
		t.Run("with 2 of 3", func(t *testing.T) {
			tx := testhelpers.TxFromHex(t, "010000000001015d4b529f841a4beac6f56abd91fe4b2002cd3f429064519d32dd9df10a70a87e0000000000ffffffff02203c670000000000160014a2e667bb74537ddea9aad6c1892afd320a6cba3b9009460200000000220020701a8d401c84fb13e6baf169d59684e17abd9fa216c8cc5b9fc63d622ff8c58d04004730440220115f01faaa6c0ab0e1efc94bf2b0b3953a4533de6a4070f28194d5622ea7c04a0220301224188c32f0672fc481db839d12f08459965d637138a8ace1f707d4eed91801473044022076d7b91b7f20f02d106afcd69218c580f647de7ecab7a8e055a6ca1a654241d70220071c03fb4fc88bd8ddfbb70eb869ddce969e8fb41608712a409201ad4f577fe401695221022b003d276bce58bef509bdcd9cf7e156f0eae18e1175815282e65e7da788bb5b21035c58f2f60ecf38c9c8b9d1316b662627ec672f5fd912b1a2cc28d0b9b00575fd2103c96d495bfdd5ba4145e3e046fee45e84a8a48ad05bd8dbb395c011a32cf9f88053ae00000000")
			t.Logf("view online: https://mempool.space/tx/%s", tx.TxHash().String())
			in := tx.TxIn[0]
			info := NewParsedScript(in.SignatureScript, in.Witness...)

			require.True(t, isSegwitMultiSig(in.Witness...))

			require.True(t, info.IsSegwitMultiSig())

			keys, minKeys, err := info.MultiSigKeys()
			require.NoError(t, err)
			require.Len(t, keys, 3)
			require.Equal(t, 2, minKeys)
			for _, k := range keys {
				require.True(t, k.IsOnCurve())
			}
		})

		t.Run("with 3 of 4", func(t *testing.T) {
			tx := testhelpers.TxFromHex(t, "010000000001022b47f72e07addb9d2cd8dabae7209e328cbe9936f50c5fc889e52db07d8f5f9d0000000023220020b2a5eebd500c9f082370f568ea42dda922c212f20c44ab8a42bc6ffafc059ee2ffffffff3fad453aff9fc5b49409f5f8c1d614a95a5bcfd75634f3e721693f97596344440100000023220020b2a5eebd500c9f082370f568ea42dda922c212f20c44ab8a42bc6ffafc059ee2ffffffff01d43c0100000000001976a9142b4891b9aaba7e065d31c49588700073cac5176088ac0500483045022100a505ea5c7bd3473175b187b94199185bef1ac06d353dd7ecd384d82e1964520b02200ccc8478e0cc791ec6fcebf6e59452b05fc519cbe0a779cdd5128d7cb2a672db01473044022033642df7b96f30416c1a5d429cdaaba1df529e2470f4e7b450aad5a0ffb102200220792710ac35e8393096859cd35a7e3fca9db5b30b3fec00aa6c01c1f984dfed130147304402207022bac2a7ec5f437db9a780a37c9c08c37147b98ac8ff975148dbb62e49176802205aa655d4ff824616bb617ff2dcb880b159d46db8715dfeebd9deaeb9560e9756018b532102a744e998361204cbe1d7f2739d71cfb91784fd2a5543204835d73e6938e759f52102c75f27ced77825cab5b589b69cb97cb900ed2e29a2181017b6f400cd212c337421034116032003f531797ea62172d04673cc48b9ef7c93777155b74d21a75392872421039340145b71c845766b81ce2631ee2f7b46d28343370a4fe2b1077a197cdcb83254ae0500483045022100a06b00573602b7be97e11e860a151b273231cfdf6e7431299d32ed3954f8b310022026c811a4101f4b00920d4efa4690ee10daa13f2ed20e8cdd7dff7a67c77345b00147304402201b45a7d8893fb453200fdee1b49e2673d60bd6883dd405f0fec4719fc7f10b88022059079c13a61f052c1edd8a11349cb49fc3f7cfd1b9525bbfec7436df19d2f2c90147304402204d343878d9230ee8ddc9b88e00577331ada261393f869c8aa72b555b6ea6fbce022037ab0eca42566a94944f373afe43c59f3ce0055ffc2184e144c9998063f4446b018b532102a744e998361204cbe1d7f2739d71cfb91784fd2a5543204835d73e6938e759f52102c75f27ced77825cab5b589b69cb97cb900ed2e29a2181017b6f400cd212c337421034116032003f531797ea62172d04673cc48b9ef7c93777155b74d21a75392872421039340145b71c845766b81ce2631ee2f7b46d28343370a4fe2b1077a197cdcb83254ae00000000")
			t.Logf("view online: https://mempool.space/tx/%s", tx.TxHash().String())
			in := tx.TxIn[0]
			info := NewParsedScript(in.SignatureScript, in.Witness...)

			require.True(t, isSegwitMultiSig(in.Witness...))

			require.True(t, info.IsSegwitMultiSig())

			keys, minKeys, err := info.MultiSigKeys()
			require.NoError(t, err)
			require.Len(t, keys, 4)
			require.Equal(t, 3, minKeys)
			for _, k := range keys {
				require.True(t, k.IsOnCurve())
			}
		})

		t.Run("with 1 of 1", func(t *testing.T) {
			tx := testhelpers.TxFromHex(t, "010000000001028caac84aa0d8c1e5e814b0bdd053061c505fbecc9a27e3b5500b36744275c94e0100000000ffffffff22ec2b0a71acf48a1713608153dfd1a044e53e0a37a98c4c022778bba5782a7e00000000232200207cc127d8f5baed77b15cdcc7772d73e88fe4a5055a1d10cc17baa87579b5399affffffff32cab53700000000002200202d69d539c3f01a41c79910c03902c812f09a8895c9ffac9bf57a8048128347f950ae420000000000220020cabbb56da08eac587612bb5456256889ec78c26ef31d8bd4a31cb6cfc6b30b41f034440000000000220020459258d11716464ff9783088ea8be7f441b851c83e44e53b716b454deb202343108344000000000022002007fc977713bad70da61e76f97efd41f60706ac4142f6741f053c196fa8104d9e8094450000000000220020bf911cc9d276eded8858d1df7e5aa61a8280e7369f53caea2177560d4b951c5b60b747000000000022002022a6a33a27ecacd58862a47cc01de72fba6934a8612e8e448304456df70d5ae73cbc470000000000220020b7cb9c4f9a4cfa3c214c13e83027e96a9d08b8f62834adde30472056f15f2fd1c0a1480000000000220020ce4523a35626d898be2954436c92fba3ada508312a7a4ecd975aaa91bc7159d110d64b000000000022002078d4ba0d5c3b5d4a6c802501de9b16458a314e51f697df92e9108090b0473f2f20fd4b000000000022002053cc3546faeef75ebc0f5037b99d37906a357266bc4bfd2588b92d75b9b8495b206e4e00000000002200205a8ff8f077518ca70a380dde821f28f168554c70f36154994f7fb952cf55808740bc4e000000000022002063d0d7c063f1f2fcc1c28239c10f6d6856325aa5c42822aa21e69f261ce8c186d01b5000000000002200206c92810f76a9fe3e7d06df18fd86b85f1d6eea7811191d815daf41982727de2d10b850000000000022002051986c744fce681d2e9c8d09b8140ce922ffaed8426abbd8262f1c377e834a439061540000000000220020393af09c71d720d22faada80230510681150d0e34bd0b5250f538178578a8e2eb0af54000000000022002075b3e360cdc6cba1478e6159619e184864ff06024f2899e8eeda6aa92905be59503656000000000022002088a8f8c3c1f91e4bcda9405e6ab1d16d9913675fa237934f45b3eb4b00651b15605d5600000000002200202dedfcc96c642725b629748d3a04cbc52199521dbb60b294a1f56307b00b62e37084560000000000220020a4b01e38cc6c5efad516ead8ace7cb3e697ac5196e0883fa07ffcc5934ea90ee00e4570000000000220020c2e92383fd4004e82bdc7aa4138cc3d4438a06b86bd433464bb551a3b406f3cff02d5a0000000000220020b4e1386f8128ecd5562585c29dacb9e4767328a674e5bcb5d8b2bb0b1db4ef24107c5a000000000022002092de45780895dce3c5c8bc6af6edf51154c66daa740170689ff972a2f7c836a5c0295c00000000002200203a361828411bb0922ec82ec459a45b651bd9e8a64571bb9bd97677e1f079582610ed5c00000000002200207917d278f5dbaf5c4390aab875dc9f126f5e6ab9bac744b4cf2b6f24432d3092b0e4600000000000220020cd2d8a4ed042700b4347c8941f6714f1c94023306a585ed12b7311cc086ffd79d032610000000000220020ffb085f71eb96153f9965e4226d786c8ce404fa7713cc234b29d79942a64533cd014660000000000220020235766f590cde263b405adcbe8b22267b6fc1c39d83986c918dec234edffa94a10b1660000000000220020142c0034fa681a65bfb7d1a9c6570db6c17fdd81707e2e5c48909009fa6692f6c05e6800000000002200205dfd0ad8a5407a791028cd38d3288a6dd2994f870deb78a78998b562f0b67d362049690000000000220020bfab713b868ec27809a18f1fe6fc536a5fb71f9ba6f5d2f2724852d8fecff44c40976900000000002200204e6768738dbd5dcfa48814b5bf454ceef97696a0946b8a7b91d833ee9be4368bb0196d0000000000220020eed023a41aab2f977262b5ef40dddda723c82e6bcbd0fbfbb0d13720c6f9a509e08e6d0000000000220020fef8c379ee9309b1e20bdf623c929ccc7ef8ffdba09e44c3bd426e1333afe6e010046e000000000022002061f98aeb5955d1e72c987b13df4323d2c7aefa3bb1f445335f4e7ffe6164cdde004e7000000000002200207ecbbee4c1339fcedcdb5413e108493a08ae717e1b920d838ef1dee72438c10160387100000000002200207146335b7c4713493c49cc3ba8446f9c4953db346ff8324215382e94aaafdc72f09772000000000022002007659bd06324bf799e8408ba767d7dcc53aadadfcf02421cbdf1fc59e8e4525b0030750000000000220020782ac4ea9d2cf7e6ea25c03a7332f1fd76661a6b1c87c9edcb824de6d94cfd4200a17700000000002200207541dc79b5eeaa08f81763189208d760745d655ddcd0b53c1d0a5c2d359d0fb6b04e79000000000022002010a3383f596f11e923f4aafff7870401b8e0686209972ccafb2e17a663cd91aae0c3790000000000220020ed60025e0626ae08f27d292161e6755175bbd284b6b14ffc800cb3cf7b53c913f0ea790000000000220020a2d6bcef8f3027034eb9826466ac0f4f2a7055b4741d269695a78f3f00694c3e804a7b0000000000220020b7c7857e5c5397c140db112a4b133f542498017f4783d92d8826b906cdb72efeb0bf7b0000000000220020e50349ea4104a297f0d67a8fce0434110018b4ebdf6a4c05fefdbe70dcf64fba00837c00000000002200206c245b7a87229cec750ae896e6b544212e3419d8a65dd178418f62530b9eb2dcc0577e0000000000220020618339a593ccd8863c24c348c774cbdc1234e90d2736de8a10c361db591a934520427f0000000000220020a2ee7c79713a96dcbd9481de60f7ba474e64efa10dda449fdf34f3b2294cd71140907f00000000002200200148130a68eeb5427138c1775750be7569ac9e36ba09fa7e0c1e8277cd50d4df50b77f000000000022002082d8981b46fe3ece540de172fae40db2aa67d48f7bbd90e6fb554a561a2a0fada07a800000000000220020cf872c6c53b765539b4be64dca0ba584db2925881d51c8c6ed89245fb1380e0b0300483045022100bd98c6416712dff8e2853241762b987f7dac2b98a243c5de365d1e037f169d4e0220446aa250e3f8b07a0bcc65252ef5bbbedd53de110660be6d9e792f89b8e4ff0301255121033f1237cf1d8a5ff8743f513859314d90025ec8309f01d43c2184dff91ed99abe51ae0300473044022077bc8c11506ae0d11f67631309b3f90e5503fc7399d68f7440c2295a6eebc611022069dedd7d0e5a4a1f4474b7fd3456686b15b23cb4edfe0e1457271d494e21bcc601255121039134672ee6f1255d1026557340d8822fc1a18637208e5cc67d5e17d0a96b0a1151ae00000000")
			t.Logf("view online: https://mempool.space/tx/%s", tx.TxHash().String())
			in := tx.TxIn[0]
			info := NewParsedScript(in.SignatureScript, in.Witness...)

			require.True(t, isSegwitMultiSig(in.Witness...))

			require.True(t, info.IsSegwitMultiSig())

			keys, minKeys, err := info.MultiSigKeys()
			require.NoError(t, err)
			require.Len(t, keys, 1)
			require.Equal(t, 1, minKeys)
			for _, k := range keys {
				require.True(t, k.IsOnCurve())
			}
		})

	})

	t.Run("should detect P2PKH", func(t *testing.T) {
		tx := testhelpers.TxFromHex(t, "0100000001c2c26dd75a21ecedd4da168791c18a85afbb5ef4ad32a839090637415bee7400010000006b483045022100d82904b1b140fcb8b51ee8c5566c51edfecbb4ada366aa4839811383285a3106022043ffa01e14de87e7080fafdf2d112ef8fc638a5c39d213fbe36247296e5df53d0121028251724a83c93c093c2be109f65bf3f3b10f33ee6467cd84717c1186bd122470ffffffff020000000000000000306a2e9b25c2802fb601fb512294841a14f125b0fa4c4083d19141e235a88d39674ba6f17156ddfc5335e225380d30f35ce0493a00000000001976a914fd20e1f76a1245264683c67830b4163fbd9319b688ac00000000")
		t.Logf("view online: https://mempool.space/tx/%s", tx.TxHash().String())
		in := tx.TxIn[0]
		info := NewParsedScript(in.SignatureScript, in.Witness...)

		require.True(t, info.IsP2PKH())
		key, err := info.PublicKey()
		require.NoError(t, err)
		require.NotNil(t, key)
		require.True(t, key.IsOnCurve())
	})

	t.Run("should detect P2WPKH", func(t *testing.T) {
		tx := testhelpers.TxFromHex(t, "010000000001029535cc822cf304ab387529d42fc046f4b5008cf08792c2911a5e563399852ad30100000000ffffffffe4a9020553334c0cfeb0b487aa647a84feb5095b4d9a3fe65d11ad04b788a8f60100000000ffffffff02f09e5c00000000001976a9143cdb231544122b9d00d07243a9732e4eeadf16e488ac60230000000000001600148d310acec1cb3c14eca9084b07c2a6e13264a9550247304402200cd07173982a1a96794ed174c4265fcfba41a175fb461bd86c9558eddbc64f0c02204b732786f05ed807ae6cd0c9d47906a440844d1f41518fef1a47db1d8ebe707c012102bb6f0d424dfedc310291e5a237bc833bc73c4a2ed6fbd69b1ce73acd4fe2f3e102483045022100dfe2fa6b1b4b570039b91d50967a1df2a75bb0e558a32f5bf3914a5aa50a193802200c9cab49dd8a7e22d783f375de205c1716ccc138aa92d83d0a6b981a41cdf853012102bb6f0d424dfedc310291e5a237bc833bc73c4a2ed6fbd69b1ce73acd4fe2f3e100000000")
		t.Logf("view online: https://mempool.space/tx/%s", tx.TxHash().String())
		in := tx.TxIn[0]
		info := NewParsedScript(in.SignatureScript, in.Witness...)

		require.True(t, info.IsP2WPKH())
		key, err := info.PublicKey()
		require.NoError(t, err)
		require.NotNil(t, key)
		require.True(t, key.IsOnCurve())
	})
}
